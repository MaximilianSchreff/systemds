
source("scripts/nn/networks/resnet.dml") as resnet

X = matrix(1, rows=2, cols=3*4*4)
Hin = 4
Win = 4
C = 4
W_conv1 = matrix("-0.05263697 -0.0445397   0.0093925   0.00985181 -0.00776336 -0.05118359  0.00999319 -0.00689699 -0.03241587  0.00694231  0.067941   -0.04806807
                      -0.03885989 -0.01439494  0.07603513 -0.0587883  -0.01599471 -0.04950817 -0.07426196
                       0.02478634  0.00639504 -0.04050444  0.02226093 -0.05027007 -0.03783846  0.05418035
                       0.03002547  0.00519022  0.06975642  0.06858082  0.05124415  0.03027143  0.0321722
                      -0.03300371 -0.03434728  0.05437119 -0.01732179  0.00638738  0.00520203 -0.054514
                      -0.05796816  0.01252741 -0.03652806  0.03441597  0.06268737 -0.08011856 -0.0256919
                       0.03296663 -0.00303325 -0.02044214 -0.04191072 -0.00974797  0.05171838 -0.03903773
                                                   0.03666271  0.02783666  0.03112164 -0.031659   -0.02719712 -0.05900747 -0.06381953
                                                   0.06931984 -0.01182205 -0.04774458  0.04433998 -0.04521645 -0.00208793  0.07713555
                                                  -0.08246719 -0.01637907 -0.03818455  0.06284595 -0.07512523 -0.02401156 -0.03586285
                                                   0.05303246  0.05766168 -0.05971466  0.01878244 -0.05454797  0.03780352 -0.00631345
                                                  -0.03226814 -0.08085325 -0.00688208 -0.07341807 -0.02381394  0.04735576  0.0462267
                                                   0.0698044   0.05985521  0.06147413  0.0592669   0.02003025  0.04131313  0.00246791
                                                  -0.00847235  0.05384384 -0.04097134  0.0239929   0.07070275  0.07980677  0.04314888
                                                                               0.03499166  0.04766005 -0.04448437 -0.02548063  0.01357474 -0.03135158 -0.05501449
                                                                              -0.05842873 -0.00996602 -0.06311086  0.03755946  0.03612795  0.01995677  0.00792566
                                                                              -0.07644863  0.03361183 -0.01252944  0.06135784 -0.06661198  0.00292504  0.02204718
                                                                               0.03653271 -0.01362504  0.00496203 -0.06816308 -0.01461299  0.06790771 -0.07058037
                                                                              -0.06983665  0.02687426  0.02938705 -0.07553603  0.0309118  -0.01878936  0.02642754
                                                                              -0.0458784  -0.0436682  -0.03355693 -0.01590653 -0.06371128 -0.0047581   0.01685412
                                                                              -0.03518845  0.03599816
                       0.00214462 -0.0195231  -0.01493067  0.08025491  0.07229881
                           0.05468962  0.07941628 -0.04745603 -0.01586362 -0.06132704 -0.07849112  0.02972905
                          -0.0361982   0.06418552 -0.04936295 -0.07333888 -0.08194072 -0.056392   -0.05033448
                           0.08188438 -0.04204595 -0.01553366 -0.00471748 -0.07901353  0.01246156 -0.03346482
                          -0.06706983 -0.04414069  0.00658292 -0.06238039  0.05874793 -0.01375275  0.03582556
                           0.00967284 -0.02738323  0.0335099   0.05992195  0.02117757  0.01396307 -0.00765312
                          -0.00620832  0.07380967 -0.06901374 -0.03594068 -0.04355255  0.00389022  0.07822487
                           0.04218224  0.02585203 -0.05305533 -0.06917024 -0.05880085  0.01545151 -0.07268117
                                                      -0.02641305  0.01972415  0.03004956 -0.03657315  0.03549194 -0.07745916 -0.05420969
                                                      -0.01182615 -0.00736813  0.06593375  0.05580068 -0.04517515  0.0505497  -0.04397855
                                                       0.06738873 -0.01323278  0.01604444 -0.02119688 -0.07466432  0.04392675  0.03442013
                                                       0.01591612 -0.03679928 -0.02551557 -0.02268149  0.05555867  0.01684397  0.05645399
                                                       0.00493198  0.06388436 -0.03403243 -0.04411599 -0.05329993  0.02992149 -0.02574863
                                                      -0.0361724   0.03145158  0.01144343 -0.01771548 -0.03430323  0.01858827 -0.01890821
                                                      -0.04063128  0.01995863 -0.03750847 -0.07892092 -0.0530495   0.0461925  -0.03715789
                                                                                  -0.06236288  0.04484476 -0.01250564  0.05984223 -0.03431253  0.02574642 -0.03453145
                                                                                  -0.05382442 -0.03554405 -0.05747258  0.07572861 -0.0225709  -0.05021684  0.01642461
                                                                                  -0.06000696  0.05553181 -0.05175616 -0.07533241 -0.02028565  0.02020475 -0.07215354
                                                                                   0.04025011 -0.02517241 -0.02739248  0.00559     0.07905376  0.06834869 -0.03331472
                                                                                   0.01961761  0.03085737  0.0403768  -0.0202361   0.0738323  -0.01574935  0.03054488
                                                                                  -0.06386979 -0.0564799   0.06815575 -0.00751196 -0.05225692 -0.01669024  0.03531223
                                                                                  -0.05834674  0.02387555
                      -0.03694921 -0.06675101 -0.05858896  0.07227662  0.03622095
                           0.03893943 -0.07775965 -0.03218026 -0.00511958 -0.03569292  0.04882777 -0.00023857
                           0.03554558 -0.03077176 -0.03938418 -0.02660518  0.06598586 -0.08030038  0.07155897
                           0.02735181  0.02010882  0.02739002  0.04196092 -0.0027729   0.02374524 -0.01535398
                           0.04613443  0.04904804 -0.0485761  -0.07907592  0.01099075  0.04652506  0.07591617
                          -0.07444738  0.06322186 -0.04040959 -0.00932734  0.01643944 -0.01791487 -0.03249663
                           0.01460589  0.06177999  0.00975163  0.07702614  0.07183413 -0.05114094  0.0370331
                           0.0275634  -0.06275275 -0.07933187 -0.06482521 -0.04183927  0.00432407 -0.03004234
                                                      -0.04175464 -0.08229894 -0.03584416 -0.01475297  0.01854926  0.03588716  0.03271718
                                                      -0.04865088  0.05161245 -0.0573089  -0.0807924  -0.03339043 -0.00647415  0.0260395
                                                       0.04083218  0.07653539 -0.04468419  0.01648841 -0.0779911  -0.0216946   0.08100754
                                                      -0.04383663  0.00469871 -0.05581096  0.00409743  0.05362259 -0.00912551  0.03728056
                                                       0.07491064  0.0250412  -0.05044965 -0.02280259  0.03879401 -0.00870223  0.00690644
                                                       0.04040129  0.08212893  0.05063398  0.05368675  0.07785168 -0.07940041 -0.04445221
                                                       0.02378895 -0.06582401  0.06232709  0.00578837 -0.01503614  0.05468862 -0.00424273
                                                                                  -0.02766509 -0.0233188  -0.00738525  0.05191331 -0.05681546  0.0011906  -0.03480245
                                                                                   0.01734515 -0.04647735 -0.07612661 -0.02801715 -0.01389543  0.07531373 -0.067654
                                                                                   0.00128664  0.01962424  0.07829903 -0.04905846 -0.00822157  0.0370203  -0.05460086
                                                                                   0.02337895  0.04244408  0.06567949  0.03465582 -0.08197263 -0.08193044 -0.05029464
                                                                                   0.03306835 -0.0477506   0.02629503 -0.0061859   0.02904812  0.02977215 -0.03503761
                                                                                  -0.07843405  0.03404651  0.06767341  0.03967692 -0.07859144 -0.06584745  0.04287612
                                                                                  -0.07417664 -0.0004738
                       0.04929864 -0.0303711   0.03191011 -0.06379331  0.00972749
                           0.03435388  0.01022929  0.03672286 -0.07741912  0.0790773   0.02933426 -0.0464197
                           0.04858586  0.01585045  0.08112314 -0.07229469  0.01338893  0.02175263 -0.01914912
                           0.04099214 -0.02591494 -0.04340935  0.03239234 -0.01159652 -0.06458107  0.07099058
                           0.0695195  -0.02370428 -0.04275648  0.06953649  0.03924649  0.05521202  0.07275879
                          -0.04110926 -0.03328523  0.07808176  0.03421798  0.0635992   0.05560812  0.01569718
                           0.03757577  0.04315341  0.04888199 -0.06562461 -0.07095747 -0.07637144 -0.02385904
                           0.04480231  0.05509925 -0.05429235  0.03473095  0.00734247 -0.01108643  0.06983326
                                                       0.00968008 -0.01518013  0.03181113  0.01916365  0.02792789  0.01130325 -0.0162202
                                                       0.01901633 -0.07146056  0.08093464  0.05938387 -0.06110789 -0.04888036  0.02448432
                                                      -0.0038577   0.03129657 -0.03154557 -0.0131881  -0.03744875 -0.03664385  0.04013993
                                                       0.03472977  0.07694504  0.0320897  -0.05446491  0.05221783 -0.04868421 -0.02787746
                                                      -0.05001862  0.0459642  -0.06836007 -0.01210515 -0.08137442  0.0290001   0.06471343
                                                      -0.06585766 -0.00476558 -0.03087578  0.05679563 -0.06619933  0.04008359  0.04978316
                                                       0.02059433  0.06456447 -0.02260039  0.05509423  0.07145666 -0.01435976 -0.07418995
                                                                                  -0.03567358  0.0580707   0.08025858  0.01562966  0.00796659 -0.05248556  0.02223586
                                                                                  -0.01409167  0.05600657  0.03353637 -0.01428091 -0.01321204  0.05676936 -0.03813297
                                                                                  -0.05393364 -0.05110275 -0.00915553 -0.05344168  0.08207145 -0.03609797 -0.0289282
                                                                                  -0.00878108  0.05774602  0.04455322 -0.03598086 -0.05430581 -0.04147321  0.06003869
                                                                                  -0.04852998 -0.00549926 -0.02933696  0.078162    0.00403464  0.0446339   0.0078705
                                                                                  -0.06203355  0.03790399 -0.05479765 -0.02521555  0.06498423  0.07039675 -0.06002037
                                                                                  -0.04606177 -0.05550714
                 ", rows=4, cols=3*7*7)
gamma_bn1 = matrix(1, rows=4, cols=1)
beta_bn1 = matrix(0, rows=4, cols=1)
reslay1 = list(W_conv1)
reslay2 = list(W_conv1)
reslay3 = list(W_conv1)
reslay4 = list(W_conv1)
W_fc = W_conv1
model = list(W_conv1, gamma_bn1, beta_bn1, reslay1, reslay2, reslay3, reslay4, W_fc)
mode = "train"
ema_mean_bn1 = matrix(0, rows=4, cols=1)
ema_var_bn1 = matrix(1, rows=4, cols=1)
ema_means_vars = list(ema_mean_bn1, ema_var_bn1, reslay1, reslay2, reslay3, reslay4)


out_expected = matrix("1.2749 1.3412 1.6747 1.3856 1.2749 1.3412 1.6747 1.3856", rows=2, cols=4*1*1)

# To test you need to change C to 4 instead of 64
[out, ema_means_vars_upd] = resnet::resnet18_forward(X, Hin, Win, model, mode, ema_means_vars)

print(toString(out))
